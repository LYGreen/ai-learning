<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Timetable Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            overflow-x: hidden;
        }

        .container {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: #2c3e50;
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 20px;
            background: #1a252f;
            text-align: center;
            border-bottom: 3px solid #3498db;
        }

        .sidebar-header h1 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 0.85rem;
            color: #bdc3c7;
        }

        .nav-sections {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -ms-flex-direction: column;
            flex-direction: column;
            gap: 10px;
            -webkit-box-pack: justify;
            -ms-flex-pack: justify;
            justify-content: space-between;
            height: 90%;
            padding: 15px;
        }

        .nav-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            color: #7f8c8d;
            margin-bottom: 10px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .nav-item {
            padding: 10px 15px;
            margin: 5px 0;
            background: #34495e;
            border-radius: 5px;
            cursor: pointer;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            font-size: 0.9rem;
        }

        .nav-item:hover {
            background: #3498db;
            -webkit-transform: translateX(5px);
            transform: translateX(5px);
        }

        .nav-item.active {
            background: #3498db;
            font-weight: 600;
        }

        .main-content {
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            margin-left: 280px;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            -webkit-box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: justify;
            -ms-flex-pack: justify;
            justify-content: space-between;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h2 {
            color: #2c3e50;
            font-size: 1.5rem;
        }

        .controls {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            gap: 10px;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .form-select {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }

        .form-select:focus {
            outline: none;
            border-color: #3498db;
        }

        .timetable-container {
            background: white;
            border-radius: 10px;
            -webkit-box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            overflow-x: auto;
        }

        .timetable {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .timetable th,
        .timetable td {
            border: 1px solid #95a5a6;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
            font-size: 0.85rem;
        }

        .timetable th {
            background: #7f8c8d;
            color: white;
            font-weight: 600;
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .period-header {
            background: #566573;
        }

        /* Teachers timetable: right border + white header text (1st, 2nd, …) */
        .view-teachers .timetable th:last-child,
        .view-teachers .timetable td:last-child {
            border-right: 2px solid #2c3e50;
        }
        .view-teachers .period-header th,
        .view-teachers .periods-day-header {
            color: white !important;
        }
        .view-teachers .periods-day-header {
            background: #1a252f !important;
            min-width: 62px;
            border-left: 2px solid #f39c12;
            line-height: 1.3;
            padding: 6px 4px;
            font-size: 0.9rem;
        }

        .time-row {
            background: #34495e;
            font-size: 0.8rem;
        }

        .class-cell {
            font-weight: 700;
            background: #ecf0f1;
            min-width: 120px;
            font-size: 0.9rem;
        }

        .day-cell {
            font-weight: 700;
            background: #d5dbdb;
            min-width: 100px;
        }

        .subject-cell {
            min-width: 100px;
            height: 60px;
            position: relative;
            cursor: pointer;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }

        .subject-cell:hover {
            background: #f39c12 !important;
            -webkit-transform: scale(1.02);
            transform: scale(1.02);
            z-index: 5;
            -webkit-box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .subject-name {
            font-weight: 700;
            font-size: 0.85rem;
            display: block;
            margin-bottom: 3px;
            color: #2c3e50;
        }

        .teacher-name {
            font-size: 0.8rem;
            color: #555;
            font-weight: 500;
        }

        .break-cell {
            background: #f39c12 !important;
            color: white;
            font-weight: 700;
        }

        .grade-10 {
            background: #d6eaf8;
        }

        .grade-9 {
            background: #d5f5e3;
        }

        .grade-8 {
            background: #fef9e7;
        }

        .grade-7 {
            background: #fdebd0;
        }

        .grade-6 {
            background: #fadbd8;
        }

        .grade-5 {
            background: #e8daef;
        }

        .grade-4 {
            background: #d7bde2;
        }

        .grade-3 {
            background: #a9cce3;
        }

        .grade-2 {
            background: #82e0aa;
        }

        .grade-1 {
            background: #f9e79f;
        }

        .grade-nursery {
            background: #e5e8e8;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
            justify-content: center;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
        }

        .modal.active {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-animation: slideIn 0.3s;
            animation: slideIn 0.3s;
        }

        .modal-content::-webkit-scrollbar {
            display: none;
        }

        @-webkit-keyframes slideIn {
            from {
                -webkit-transform: translateY(-50px);
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                -webkit-transform: translateY(0);
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: justify;
            -ms-flex-pack: justify;
            justify-content: space-between;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .close-btn {
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: #ecf0f1;
            color: #e74c3c;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .checkbox-group {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
            -webkit-animation: slideDown 0.3s;
            animation: slideDown 0.3s;
        }

        @-webkit-keyframes slideDown {
            from {
                -webkit-transform: translateY(-20px);
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                -webkit-transform: translateY(0);
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        @media (max-width: 768px) {
            .sidebar {
                -webkit-transform: translateX(-100%);
                transform: translateX(-100%);
            }

            .sidebar.active {
                -webkit-transform: translateX(0);
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .menu-toggle {
                display: block;
                position: fixed;
                top: 15px;
                left: 15px;
                z-index: 1001;
                background: #3498db;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
            }
        }

        @media (min-width: 769px) {
            .menu-toggle {
                display: none;
            }
        }

        @media print {
            @page {
                size: A4 landscape;
                margin: 5mm;
            }

            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
                box-sizing: border-box !important;
            }

            html,
            body {
                width: 100% !important;
                max-width: 297mm !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                overflow: visible !important;
            }

            .sidebar,
            .controls,
            .menu-toggle,
            .btn,
            .header,
            #alertContainer {
                display: none !important;
            }

            .container {
                display: block !important;
            }

            .main-content {
                margin-left: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                max-width: 287mm !important;
                box-sizing: border-box !important;
            }

            /* ── Print title ── */
            .timetable-container::before {
                content: "SCHOOL TIMETABLE";
                display: block;
                text-align: center;
                font-size: 11pt;
                font-weight: 700;
                color: #1a252f;
                letter-spacing: 3px;
                text-transform: uppercase;
                padding: 2mm 0 2mm;
                border-bottom: 2pt solid #2c3e50;
                margin-bottom: 2mm;
            }

            .timetable-container {
                -webkit-box-shadow: none !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                overflow: hidden !important;
                border: 2pt solid #2c3e50 !important;
                width: 100% !important;
                max-width: 287mm !important;
                box-sizing: border-box !important;
            }

            /* ── ALL CELLS: strong border on every cell ── */
            .timetable th,
            .timetable td {
                border: 0.8pt solid #2c3e50 !important;
                padding: 1.5pt 2pt !important;
                text-align: center !important;
                vertical-align: middle !important;
                word-wrap: break-word !important;
                overflow: hidden !important;
            }

            /* Right edge: last column border so right side prints clearly */
            .timetable th:last-child,
            .timetable td:last-child {
                border-right: 2pt solid #2c3e50 !important;
            }
            .timetable {
                width: 100% !important;
            }

            /* ── Header rows ── */
            .period-header th {
                background: #2c3e50 !important;
                color: white !important;
                font-size: 7pt !important;
                font-weight: 700 !important;
                padding: 2.5pt !important;
                border: 0.8pt solid #1a252f !important;
            }
            .view-teachers .period-header th,
            .view-teachers .periods-day-header {
                color: white !important;
            }

            .time-row th {
                background: #566573 !important;
                color: white !important;
                font-size: 5pt !important;
                font-weight: 600 !important;
                padding: 1.5pt !important;
                white-space: nowrap !important;
                border: 0.8pt solid #1a252f !important;
            }

            /* ── Label cells ── */
            .class-cell {
                background: #d5d8dc !important;
                font-weight: 700 !important;
                font-size: 6pt !important;
                color: #1a252f !important;
                border-right: 1.5pt solid #2c3e50 !important;
                border: 0.8pt solid #2c3e50 !important;
                white-space: nowrap !important;
            }

            .day-cell {
                background: #d5d8dc !important;
                font-weight: 700 !important;
                font-size: 6.5pt !important;
                color: #1a252f !important;
                border: 0.8pt solid #2c3e50 !important;
                border-right: 1.5pt solid #2c3e50 !important;
            }

            /* ── Subject cells ── */
            .subject-cell {
                height: auto !important;
                padding: 1.5pt 2pt !important;
                cursor: default !important;
                border: 0.8pt solid #2c3e50 !important;
            }

            .subject-cell:hover {
                -webkit-transform: none !important;
                transform: none !important;
                -webkit-box-shadow: none !important;
                box-shadow: none !important;
                background: inherit !important;
            }

            .subject-name {
                font-weight: 700 !important;
                font-size: 6.5pt !important;
                color: #1a252f !important;
                display: block !important;
                margin-bottom: 0.5pt !important;
                line-height: 1.2 !important;
            }

            .teacher-name {
                font-size: 5.5pt !important;
                color: #2c3e50 !important;
                font-weight: 600 !important;
                display: block !important;
                line-height: 1.2 !important;
            }

            .common-badge {
                display: none !important;
            }

            /* ── Break column: narrow + vertical ── */
            .break-cell {
                background: #e67e22 !important;
                color: white !important;
                font-weight: 700 !important;
                font-size: 5.5pt !important;
                writing-mode: vertical-lr !important;
                -webkit-writing-mode: vertical-lr !important;
                text-orientation: mixed !important;
                padding: 2pt 1pt !important;
                letter-spacing: 0.5pt !important;
                border: 0.8pt solid #c0392b !important;
            }

            /* ── Grade row colors ── */
            .grade-10 {
                background: #d6eaf8 !important;
            }

            .grade-9 {
                background: #d5f5e3 !important;
            }

            .grade-8 {
                background: #fef9e7 !important;
            }

            .grade-7 {
                background: #fdebd0 !important;
            }

            .grade-6 {
                background: #fadbd8 !important;
            }

            .grade-5 {
                background: #e8daef !important;
            }

            .grade-4 {
                background: #d7bde2 !important;
            }

            .grade-3 {
                background: #a9cce3 !important;
            }

            .grade-2 {
                background: #82e0aa !important;
            }

            .grade-1 {
                background: #f9e79f !important;
            }

            .grade-nursery {
                background: #e5e8e8 !important;
            }

            /* ════════════════════════════════════════════
               CLASSES TIMETABLE  (15 classes × 9 cols + break)
               col1=class 13mm | col7=break 6mm | 9 periods share rest
               268mm / 9 = 29.8mm each
            ════════════════════════════════════════════ */
            .view-classes .timetable {
                width: 100% !important;
                min-width: unset !important;
                border-collapse: collapse !important;
                table-layout: fixed !important;
                font-size: 6.2pt !important;
            }

            .view-classes .timetable th:nth-child(1),
            .view-classes .timetable td:nth-child(1) {
                width: 13mm !important;
            }

            .view-classes .timetable th:nth-child(7),
            .view-classes .timetable td:nth-child(7) {
                width: 6mm !important;
            }

            .view-classes .timetable th:nth-child(2),
            .view-classes .timetable td:nth-child(2),
            .view-classes .timetable th:nth-child(3),
            .view-classes .timetable td:nth-child(3),
            .view-classes .timetable th:nth-child(4),
            .view-classes .timetable td:nth-child(4),
            .view-classes .timetable th:nth-child(5),
            .view-classes .timetable td:nth-child(5),
            .view-classes .timetable th:nth-child(6),
            .view-classes .timetable td:nth-child(6),
            .view-classes .timetable th:nth-child(8),
            .view-classes .timetable td:nth-child(8),
            .view-classes .timetable th:nth-child(9),
            .view-classes .timetable td:nth-child(9),
            .view-classes .timetable th:nth-child(10),
            .view-classes .timetable td:nth-child(10),
            .view-classes .timetable th:nth-child(11),
            .view-classes .timetable td:nth-child(11) {
                width: 29.8mm !important;
            }

            /* ════════════════════════════════════════════
               TEACHERS TIMETABLE  (18 teachers × 9 period cols + break + periods/day)
               col1=teacher 18mm | col7=break 6mm | col12=periods/day 12mm | 9 periods share rest
               287 - 18 - 6 - 12 = 251mm / 9 = 27.9mm each
            ════════════════════════════════════════════ */
            .view-teachers .timetable {
                width: 100% !important;
                min-width: unset !important;
                border-collapse: collapse !important;
                table-layout: fixed !important;
                font-size: 6.2pt !important;
            }

            .view-teachers .timetable th:nth-child(1),
            .view-teachers .timetable td:nth-child(1) {
                width: 18mm !important;
            }

            .view-teachers .timetable th:nth-child(7),
            .view-teachers .timetable td:nth-child(7) {
                width: 6mm !important;
            }

            .view-teachers .timetable th:nth-child(12),
            .view-teachers .timetable td:nth-child(12) {
                width: 12mm !important;
                white-space: normal !important;
                word-wrap: break-word !important;
                font-size: 5.5pt !important;
                font-weight: 700 !important;
                background: #1a252f !important;
                color: white !important;
                border: 0.8pt solid #0d1b2a !important;
                border-left: 1.5pt solid #f39c12 !important;
                border-right: 2pt solid #2c3e50 !important;
                padding: 2pt 1pt !important;
                line-height: 1.3 !important;
            }

            /* period count value cells */
            .view-teachers .timetable td:nth-child(12) {
                background: inherit !important;
                color: #1a252f !important;
                font-size: 8pt !important;
                font-weight: 700 !important;
                border-left: 1.5pt solid #f39c12 !important;
                border-right: 2pt solid #2c3e50 !important;
            }

            .view-teachers .timetable th:nth-child(2),
            .view-teachers .timetable td:nth-child(2),
            .view-teachers .timetable th:nth-child(3),
            .view-teachers .timetable td:nth-child(3),
            .view-teachers .timetable th:nth-child(4),
            .view-teachers .timetable td:nth-child(4),
            .view-teachers .timetable th:nth-child(5),
            .view-teachers .timetable td:nth-child(5),
            .view-teachers .timetable th:nth-child(6),
            .view-teachers .timetable td:nth-child(6),
            .view-teachers .timetable th:nth-child(8),
            .view-teachers .timetable td:nth-child(8),
            .view-teachers .timetable th:nth-child(9),
            .view-teachers .timetable td:nth-child(9),
            .view-teachers .timetable th:nth-child(10),
            .view-teachers .timetable td:nth-child(10),
            .view-teachers .timetable th:nth-child(11),
            .view-teachers .timetable td:nth-child(11) {
                width: 27.9mm !important;
            }

            /* ════════════════════════════════════════════
               INDIVIDUAL CLASS TIMETABLE  (6 days × 9 period cols + break)
               col1=day 14mm | col7=break 6mm | 9 periods share rest
               287 - 14 - 6 = 267mm / 9 = 29.7mm each
               6 data rows must fill page height — rows stretch via equal height
            ════════════════════════════════════════════ */
            .view-individual .timetable {
                width: 100% !important;
                min-width: unset !important;
                border-collapse: collapse !important;
                table-layout: fixed !important;
                font-size: 7pt !important;
                height: 185mm !important;
                /* fill most of A4 height after title */
            }

            .view-individual .timetable th:nth-child(1),
            .view-individual .timetable td:nth-child(1) {
                width: 14mm !important;
            }

            .view-individual .timetable th:nth-child(7),
            .view-individual .timetable td:nth-child(7) {
                width: 6mm !important;
            }

            .view-individual .timetable th:nth-child(2),
            .view-individual .timetable td:nth-child(2),
            .view-individual .timetable th:nth-child(3),
            .view-individual .timetable td:nth-child(3),
            .view-individual .timetable th:nth-child(4),
            .view-individual .timetable td:nth-child(4),
            .view-individual .timetable th:nth-child(5),
            .view-individual .timetable td:nth-child(5),
            .view-individual .timetable th:nth-child(6),
            .view-individual .timetable td:nth-child(6),
            .view-individual .timetable th:nth-child(8),
            .view-individual .timetable td:nth-child(8),
            .view-individual .timetable th:nth-child(9),
            .view-individual .timetable td:nth-child(9),
            .view-individual .timetable th:nth-child(10),
            .view-individual .timetable td:nth-child(10),
            .view-individual .timetable th:nth-child(11),
            .view-individual .timetable td:nth-child(11) {
                width: 29.7mm !important;
            }

            /* Individual timetable: rows must stretch to fill page */
            .view-individual .timetable tbody tr {
                height: calc(185mm / 8) !important;
                /* 1 header row + 6 data rows ~ 7 rows total */
            }

            .view-individual .subject-name {
                font-size: 8pt !important;
            }

            .view-individual .teacher-name {
                font-size: 7pt !important;
            }

            .view-individual .day-cell {
                font-size: 7.5pt !important;
            }

            /* ── Periods/Day column in print ── */
            .periods-day-header {
                background: #1a252f !important;
                color: white !important;
                font-size: 5.5pt !important;
                font-weight: 700 !important;
                white-space: normal !important;
                word-wrap: break-word !important;
                line-height: 1.3 !important;
                padding: 2pt 1pt !important;
                border-left: 1.5pt solid #f39c12 !important;
                border: 0.8pt solid #0d1b2a !important;
                border-left: 1.5pt solid #f39c12 !important;
                text-align: center !important;
            }

            .periods-day-cell {
                font-size: 9pt !important;
                font-weight: 800 !important;
                border: 0.8pt solid #2c3e50 !important;
                border-left: 1.5pt solid #f39c12 !important;
                text-align: center !important;
                vertical-align: middle !important;
                padding: 2pt !important;
            }

            /* Force single page */
            table,
            tr,
            td,
            th,
            tbody,
            thead {
                page-break-inside: avoid !important;
            }

            body {
                page-break-after: avoid !important;
            }
        }

        .section-group {
            background: #fff;
            border: 2px solid #3498db;
            border-radius: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .section-group-header {
            background: #3498db;
            color: white;
            padding: 10px 15px;
            font-weight: 600;
        }

        .section-group-content {
            padding: 15px;
        }

        .setting-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 2px solid #ddd;
            margin-bottom: 10px;
        }

        .setting-item.active {
            border-color: #27ae60;
            background: #d4edda;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #27ae60;
        }

        input:checked+.slider:before {
            -webkit-transform: translateX(26px);
            transform: translateX(26px);
        }

        .common-badge {
            display: inline-block;
            background: #27ae60;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            margin-top: 3px;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <button class="menu-toggle" onclick="toggleSidebar()">&#9776; Menu</button>

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>&#128218; School Timetable</h1>
                <p>Management System</p>
            </div>

            <div class="nav-sections">
                <div>
                    <div class="nav-title">Views</div>
                    <div class="nav-item view-item active" onclick="showView('classes', this)">&#128203; Classes
                        Timetable</div>
                    <div class="nav-item view-item" onclick="showView('teachers', this)">&#128104;&#8205;&#127979;
                        Teachers Timetable</div>
                    <div class="nav-item view-item" onclick="showView('individual', this)">&#128196; Individual Class
                    </div>
                </div>
                <div>
                    <div class="nav-title">Settings</div>
                    <div class="nav-item" onclick="showCommonTeacherSettings()">&#9881;&#65039; Common Teacher Settings
                    </div>
                </div>
            </div>
        </nav>

        <main class="main-content">
            <div class="header">
                <h2 id="pageTitle">Classes Timetable - Monday</h2>
                <div class="controls" id="controls">
                    <select class="form-select" id="daySelect" onchange="selectDay(this.value)"
                        style="display:inline-block;">
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                        <option value="Saturday">Saturday</option>
                    </select>
                    <select class="form-select" id="classDropdown" onchange="showIndividualClass()">
                        <option value="">Select Class</option>
                    </select>
                    <button class="btn btn-success" onclick="printTimetable()">&#128424;&#65039; Print</button>
                    <button class="btn btn-warning" onclick="clearDay()">&#128465;&#65039; Clear Day</button>
                </div>
            </div>

            <div id="alertContainer"></div>

            <div class="timetable-container">
                <table class="timetable" id="timetable"></table>
            </div>
        </main>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Assign Period</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <div class="info-box" id="commonTeacherInfo" style="display:none;">
                <strong>&#128204; Common Teacher Subject:</strong> <span id="commonTeacherInfoText">This subject will be
                    taught by the same teacher across sections.</span>
            </div>

            <div class="form-group">
                <label>Class</label>
                <input type="text" id="modalClass" disabled>
            </div>
            <div class="form-group">
                <label>Day</label>
                <input type="text" id="modalDay" disabled>
            </div>
            <div class="form-group">
                <label>Period</label>
                <input type="text" id="modalPeriod" disabled>
            </div>
            <div class="form-group">
                <label>Subject *</label>
                <select id="subjectSelect" onchange="onSubjectChange()">
                    <option value="">Select Subject</option>
                </select>
            </div>
            <div class="form-group">
                <label>Teacher *</label>
                <select id="teacherSelect">
                    <option value="">Select Teacher</option>
                </select>
            </div>

            <div class="checkbox-group" id="applyToAllSections" style="display:none;">
                <input type="checkbox" id="applyAllCheckbox" checked>
                <label for="applyAllCheckbox">
                    <strong id="applyAllLabel">Apply to sections</strong><br>
                    <small id="applyAllSmall">Same teacher for common sections</small>
                </label>
            </div>

            <div class="checkbox-group" style="display:flex;">
                <input type="checkbox" id="applyAllDaysCheckbox" checked>
                <label for="applyAllDaysCheckbox">
                    <strong>Apply to all days of the week</strong><br>
                    <small>Set this subject &amp; teacher for all 6 days</small>
                </label>
            </div>

            <div
                style="display:-webkit-box;display:-ms-flexbox;display:flex;gap:10px;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;margin-top:20px;">
                <button class="btn btn-danger" onclick="deleteAssignment()">Delete</button>
                <button class="btn btn-primary" onclick="saveAssignment()">Save</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content" style="max-width:800px;">
            <div class="modal-header">
                <h3>Common Teacher Settings (9th &amp; 10th Grade)</h3>
                <button class="close-btn" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div class="info-box">
                <strong>&#8505;&#65039; Common teacher rules:</strong><br>
                &bull; <strong>BS &amp; CS only</strong>: Physics, Chemistry, Math (Sci) — grades 9 &amp; 10 (toggle
                below)<br>
                &bull; <strong>Arts + BS + CS</strong>: English, Urdu, T.Q — grades 9 &amp; 10<br>
                &bull; <strong>Arts + BS + CS</strong>: Islamiat — grade 9 only<br>
                &bull; <strong>Arts + BS + CS</strong>: Pak.Studies — grade 10 only
            </div>
            <div id="commonTeacherSettings"></div>
            <div style="margin-top:20px;text-align:right;">
                <button class="btn btn-primary" onclick="saveCommonTeacherSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        // ── Data ──────────────────────────────────────────────────────────────────
        var CLASSES = [
            { id: '10TH-BS', name: '10th - Biology Science', grade: 10, section: 'BS' },
            { id: '10TH-CS', name: '10th - Computer Science', grade: 10, section: 'CS' },
            { id: '10TH-ARTS', name: '10th - Arts', grade: 10, section: 'ARTS' },
            { id: '9TH-BS', name: '9th - Biology Science', grade: 9, section: 'BS' },
            { id: '9TH-CS', name: '9th - Computer Science', grade: 9, section: 'CS' },
            { id: '9TH-ARTS', name: '9th - Arts', grade: 9, section: 'ARTS' },
            { id: 'EIGHT', name: '8th Grade', grade: 8, section: '' },
            { id: 'SEVEN', name: '7th Grade', grade: 7, section: '' },
            { id: 'SIX', name: '6th Grade', grade: 6, section: '' },
            { id: 'FIVE', name: '5th Grade', grade: 5, section: '' },
            { id: 'FOUR', name: '4th Grade', grade: 4, section: '' },
            { id: 'THREE', name: '3rd Grade', grade: 3, section: '' },
            { id: 'TWO', name: '2nd Grade', grade: 2, section: '' },
            { id: 'ONE', name: '1st Grade', grade: 1, section: '' },
            { id: 'NURSERY', name: 'Nursery', grade: 0, section: '' }
        ];

        var TEACHERS = [
            'Kazmi', 'Imtiaz', 'Faizi', 'Amanullah', 'Asad Ullah',
            'Shairyar', 'Akhtar Ali', 'Anwar', 'Ali Shair', 'Nazam',
            'Aqeel', 'Zahid Shah', 'Arshad', 'Javed', 'Hameed',
            'Mrs. Saba', 'Ms. Shahrin', 'Ms. Amina'
        ];

        var DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        var SUBJECTS = {
            '10TH-BS': ['English', 'Physics', 'Chemistry', 'Biology', 'Math (Sci)', 'Urdu', 'Pak.Studies', 'T.Q'],
            '10TH-CS': ['English', 'Physics', 'Chemistry', 'Math (Sci)', 'Computer', 'Urdu', 'Pak.Studies', 'T.Q'],
            '10TH-ARTS': ['English', 'G.Sci', 'Urdu', 'Punjabi', 'H&P.Edu', 'Math (G)', 'T.Q', 'Pak.Studies'],
            '9TH-BS': ['English', 'Physics', 'Chemistry', 'Math (Sci)', 'Biology', 'Urdu', 'Islamiat', 'T.Q'],
            '9TH-CS': ['English', 'Physics', 'Chemistry', 'Math (Sci)', 'Computer', 'Urdu', 'Islamiat', 'T.Q'],
            '9TH-ARTS': ['English', 'G.Sci', 'Urdu', 'Punjabi', 'Math (Sci)', 'H&P.Edu', 'T.Q', 'Islamiat'],
            'EIGHT': ['English', 'Computer', 'Islamiat', 'Math', 'Science', 'Geo/Hist', 'Urdu', 'T.Q'],
            'SEVEN': ['English', 'T.Q', 'Islamiat', 'Math', 'Geo/Hist', 'Urdu', 'Computer', 'Science'],
            'SIX': ['Urdu', 'Science', 'Computer', 'English', 'T.Q', 'Math', 'Islamiat', 'Geo/Hist'],
            'FIVE': ['Science', 'Math', 'English', 'Urdu-A', 'Islamiat', 'T.Q', 'Urdu-B', 'Social Studies'],
            'FOUR': ['Urdu-A', 'Social Studies', 'Math', 'T.Q', 'English', 'Islamiat', 'Science', 'Urdu-B'],
            'THREE': ['Islamiat', 'Urdu-B', 'English-A', 'G.K', 'Math', 'English-B', 'Urdu-A', 'T.Q'],
            'TWO': ['G.K', 'Urdu-A', 'English-A', 'Urdu-B', 'Islamiat', 'English-B', 'Math', 'T.Q'],
            'ONE': ['English-A', 'Islamiat', 'Tajveedi Qaida', 'Math', 'G.K', 'Urdu-A', 'Urdu-B', 'English-B'],
            'NURSERY': ['Urdu', 'Math', 'English', 'T.Q', 'Drawing/Painting']
        };

        var TIMES = {
            'Monday': ['8:55-9:35', '9:35-10:05', '10:05-10:35', '10:35-11:05', '11:05-11:35', '11:35-12:00', '12:00-12:30', '12:30-1:00', '1:00-1:30'],
            'Tuesday': ['8:55-9:35', '9:35-10:05', '10:05-10:35', '10:35-11:05', '11:05-11:35', '11:35-12:00', '12:00-12:30', '12:30-1:00', '1:00-1:30'],
            'Wednesday': ['8:55-9:35', '9:35-10:05', '10:05-10:35', '10:35-11:05', '11:05-11:35', '11:35-12:00', '12:00-12:30', '12:30-1:00', '1:00-1:30'],
            'Thursday': ['8:55-9:35', '9:35-10:05', '10:05-10:35', '10:35-11:05', '11:05-11:35', '11:35-12:00', '12:00-12:30', '12:30-1:00', '1:00-1:30'],
            'Friday': ['9:00-9:40', '9:40-10:00', '10:00-10:20', '10:20-10:40', '10:40-11:00', '11:00-11:00', '11:00-11:20', '11:20-11:40', '11:40-12:00'],
            'Saturday': ['8:55-9:35', '9:35-10:05', '10:05-10:35', '10:35-11:05', '11:05-11:35', '11:35-12:00', '12:00-12:30', '12:30-1:00', '1:00-1:30']
        };

        // BS & CS only common subjects (Physics, Chemistry, Math (Sci)) - same teacher for BS and CS only
        var COMMON_SUBJECTS_BS_CS_10 = ['Physics', 'Chemistry', 'Math (Sci)'];
        var COMMON_SUBJECTS_BS_CS_9 = ['Physics', 'Chemistry', 'Math (Sci)'];

        // Arts + BS + CS common subjects
        // Both grades: English, Urdu, T.Q
        // 9th only:    Islamiat
        // 10th only:   Pak.Studies
        var ARTS_JOINS_10 = ['English', 'Urdu', 'T.Q', 'Pak.Studies'];
        var ARTS_JOINS_9 = ['English', 'Urdu', 'T.Q', 'Islamiat'];

        // Full list of all common subjects (BS+CS only UNION Arts+BS+CS) per grade
        // Used for isCommonTeacherSubject checks and configurable settings
        var CONFIGURABLE_SUBJECTS_10 = ['Physics', 'Chemistry', 'Math (Sci)', 'English', 'Urdu', 'T.Q', 'Pak.Studies'];
        var CONFIGURABLE_SUBJECTS_9 = ['Physics', 'Chemistry', 'Math (Sci)', 'English', 'Urdu', 'T.Q', 'Islamiat'];

        // commonTeacherConfig controls which BS<->CS subjects are common
        var commonTeacherConfig = { '10': { subjects: {} }, '9': { subjects: {} } };
        var schedule = {};
        var currentDay = 'Monday';
        var currentView = 'classes';
        var currentClass = null;
        var currentPeriod = null;
        var editingCell = null;

        // ── Init ──────────────────────────────────────────────────────────────────
        function init() {
            loadSchedule();
            loadCommonTeacherConfig();
            populateClassDropdown();
            renderTimetable();
        }

        function loadSchedule() {
            try {
                var saved = localStorage.getItem('schoolTimetable');
                if (saved) {
                    schedule = JSON.parse(saved);
                    // Ensure all classes exist in schedule (for newly added classes)
                    DAYS.forEach(function (day) {
                        if (!schedule[day]) schedule[day] = {};
                        CLASSES.forEach(function (cls) {
                            if (!schedule[day][cls.id]) schedule[day][cls.id] = {};
                        });
                    });
                } else {
                    DAYS.forEach(function (day) {
                        schedule[day] = {};
                        CLASSES.forEach(function (cls) {
                            schedule[day][cls.id] = {};
                        });
                    });
                }
            } catch (e) {
                schedule = {};
                DAYS.forEach(function (day) {
                    schedule[day] = {};
                    CLASSES.forEach(function (cls) { schedule[day][cls.id] = {}; });
                });
            }
        }

        function saveSchedule() {
            try { localStorage.setItem('schoolTimetable', JSON.stringify(schedule)); } catch (e) { }
        }

        function loadCommonTeacherConfig() {
            try {
                var saved = localStorage.getItem('commonTeacherConfig');
                if (saved) {
                    commonTeacherConfig = JSON.parse(saved);
                    // Scrub any stale subjects that are NOT in the valid BS+CS-only lists
                    // This prevents old Biology/Computer entries from being marked common
                    ['10', '9'].forEach(function (grade) {
                        if (!commonTeacherConfig[grade]) commonTeacherConfig[grade] = { subjects: {} };
                        var validList = grade === '10' ? COMMON_SUBJECTS_BS_CS_10 : COMMON_SUBJECTS_BS_CS_9;
                        var cleaned = {};
                        validList.forEach(function (s) {
                            if (commonTeacherConfig[grade].subjects[s] === true) cleaned[s] = true;
                        });
                        commonTeacherConfig[grade].subjects = cleaned;
                    });
                } else {
                    // Default: BS & CS only subjects (Physics, Chemistry, Math (Sci)) all enabled
                    COMMON_SUBJECTS_BS_CS_10.forEach(function (s) { commonTeacherConfig['10'].subjects[s] = true; });
                    COMMON_SUBJECTS_BS_CS_9.forEach(function (s) { commonTeacherConfig['9'].subjects[s] = true; });
                }
            } catch (e) {
                commonTeacherConfig = { '10': { subjects: {} }, '9': { subjects: {} } };
                COMMON_SUBJECTS_BS_CS_10.forEach(function (s) { commonTeacherConfig['10'].subjects[s] = true; });
                COMMON_SUBJECTS_BS_CS_9.forEach(function (s) { commonTeacherConfig['9'].subjects[s] = true; });
            }
        }

        function saveCommonTeacherConfig() {
            try { localStorage.setItem('commonTeacherConfig', JSON.stringify(commonTeacherConfig)); } catch (e) { }
        }

        function populateClassDropdown() {
            var dropdown = document.getElementById('classDropdown');
            var html = '<option value="">Select Class</option>';
            CLASSES.forEach(function (cls) {
                html += '<option value="' + cls.id + '">' + cls.id + '</option>';
            });
            dropdown.innerHTML = html;
        }

        // ── Rendering ─────────────────────────────────────────────────────────────
        function renderTimetable() {
            var table = document.getElementById('timetable');
            var container = document.querySelector('.timetable-container');
            // Set view class for print CSS targeting
            if (container) {
                container.classList.remove('view-classes', 'view-teachers', 'view-individual');
                container.classList.add('view-' + currentView);
            }
            if (currentView === 'classes') renderClassesTimetable(table);
            else if (currentView === 'teachers') renderTeachersTimetable(table);
            else if (currentView === 'individual') renderIndividualClassTimetable(table);
        }

        function renderClassesTimetable(table) {
            var times = TIMES[currentDay];
            var html = '<thead><tr class="period-header"><th>Periods</th><th>1st</th><th>2nd</th><th>3rd</th><th>4th</th><th>5th</th><th>Break</th><th>6th</th><th>7th</th><th>8th</th></tr><tr class="time-row"><th>Time</th>';
            times.forEach(function (t, idx) {
                html += idx === 5 ? '<th>Break</th>' : '<th>' + t + '</th>';
            });
            html += '</tr></thead><tbody>';

            CLASSES.forEach(function (cls) {
                var gradeClass = cls.grade === 0 ? 'grade-nursery' : 'grade-' + cls.grade;
                html += '<tr class="' + gradeClass + '"><td class="class-cell">' + cls.id + '</td>';
                for (var p = 1; p <= 5; p++) {
                    html += renderSubjectCell(cls, p, schedule[currentDay][cls.id][p]);
                }
                html += '<td class="break-cell">BREAK</td>';
                for (var p2 = 6; p2 <= 8; p2++) {
                    html += renderSubjectCell(cls, p2, schedule[currentDay][cls.id][p2]);
                }
                html += '</tr>';
            });

            html += '</tbody>';
            table.innerHTML = html;
        }

        function renderSubjectCell(cls, period, assignment) {
            var html = '<td class="subject-cell" onclick="openEditModal(\'' + cls.id + '\',' + period + ')">';
            if (assignment) {
                html += '<span class="subject-name">' + assignment.subject + '</span>';
                html += '<span class="teacher-name">' + assignment.teacher + '</span>';
                if ((cls.grade === 10 || cls.grade === 9) && isCommonTeacherSubject(cls.grade, assignment.subject)) {
                    html += '<span class="common-badge">Common</span>';
                }
            }
            html += '</td>';
            return html;
        }

        function renderTeachersTimetable(table) {
            var html = '<thead><tr class="period-header"><th>Teacher</th><th>1st</th><th>2nd</th><th>3rd</th><th>4th</th><th>5th</th><th>Break</th><th>6th</th><th>7th</th><th>8th</th><th class="periods-day-header" style="background:#1a252f;min-width:62px;border-left:2px solid #f39c12;line-height:1.3;padding:6px 4px;font-size:0.82rem;">Periods/<br>Day</th></tr></thead><tbody>';

            TEACHERS.forEach(function (teacher) {
                html += '<tr><td class="class-cell">' + teacher + '</td>';
                var periodCount = 0;
                for (var p = 1; p <= 8; p++) {
                    if (p === 6) html += '<td class="break-cell">BREAK</td>';
                    var found = false, classInfo = '';
                    CLASSES.forEach(function (cls) {
                        var a = schedule[currentDay][cls.id][p];
                        if (a && a.teacher === teacher) {
                            found = true;
                            classInfo = cls.id + '<br><small>' + a.subject + '</small>';
                        }
                    });
                    if (found) periodCount++;
                    html += found
                        ? '<td class="subject-cell" style="background:#d5f5e3;">' + classInfo + '</td>'
                        : '<td class="subject-cell" style="background:#ecf0f1;color:#95a5a6;">Free</td>';
                }
                // Periods/Day column — color coded by count
                var countBg = periodCount === 0 ? '#ecf0f1' : periodCount <= 3 ? '#d5f5e3' : periodCount <= 6 ? '#fef9e7' : '#fadbd8';
                var countColor = periodCount === 0 ? '#95a5a6' : '#1a252f';
                html += '<td class="periods-day-cell" style="background:' + countBg + ';color:' + countColor + ';font-weight:800;font-size:1.25rem;text-align:center;vertical-align:middle;border-left:2px solid #f39c12;border:1px solid #aab7c4;border-left:2px solid #f39c12;">'
                    + (periodCount === 0 ? '<span style="color:#bdc3c7;font-size:1rem;">—</span>' : periodCount)
                    + '</td>';
                html += '</tr>';
            });
            html += '</tbody>';
            table.innerHTML = html;
        }

        function renderIndividualClassTimetable(table) {
            var selectedClass = document.getElementById('classDropdown').value;
            if (!selectedClass) {
                table.innerHTML = '<tbody><tr><td style="padding:40px;text-align:center;color:#95a5a6;">Please select a class from the dropdown above</td></tr></tbody>';
                return;
            }
            var cls = null;
            for (var i = 0; i < CLASSES.length; i++) { if (CLASSES[i].id === selectedClass) { cls = CLASSES[i]; break; } }

            var html = '<thead><tr class="period-header"><th>Day</th><th>1st</th><th>2nd</th><th>3rd</th><th>4th</th><th>5th</th><th>Break</th><th>6th</th><th>7th</th><th>8th</th></tr></thead><tbody>';
            var gradeClass = cls.grade === 0 ? 'grade-nursery' : 'grade-' + cls.grade;

            DAYS.forEach(function (day) {
                html += '<tr class="' + gradeClass + '"><td class="day-cell">' + day + '</td>';
                for (var p = 1; p <= 8; p++) {
                    if (p === 6) html += '<td class="break-cell">BREAK</td>';
                    var a = schedule[day][cls.id][p];
                    if (a) {
                        html += '<td class="subject-cell"><span class="subject-name">' + a.subject + '</span><span class="teacher-name">' + a.teacher + '</span></td>';
                    } else {
                        html += '<td class="subject-cell" style="background:#ecf0f1;"></td>';
                    }
                }
                html += '</tr>';
            });
            html += '</tbody>';
            table.innerHTML = html;
        }

        // ── Common teacher helpers ─────────────────────────────────────────────────
        // A subject is "common" ONLY if it is in the hardcoded lists — ignores any stale config
        function isCommonTeacherSubject(grade, subject) {
            // First check: is it a BS+CS-only subject AND enabled in config?
            var bsList = grade === 10 ? COMMON_SUBJECTS_BS_CS_10 : COMMON_SUBJECTS_BS_CS_9;
            var inBsCs = false;
            for (var i = 0; i < bsList.length; i++) { if (bsList[i] === subject) { inBsCs = true; break; } }
            if (inBsCs) {
                var key = grade.toString();
                if (commonTeacherConfig[key] && commonTeacherConfig[key].subjects[subject] === true) return true;
            }
            // Second check: is it an Arts-joins subject? (always active)
            return artsJoinsSubject(grade, subject);
        }

        // Does Arts join this subject as common? (only for the Arts-joins subset)
        function artsJoinsSubject(grade, subject) {
            var list = grade === 10 ? ARTS_JOINS_10 : ARTS_JOINS_9;
            for (var i = 0; i < list.length; i++) { if (list[i] === subject) return true; }
            return false;
        }

        // Returns the sections that share a common teacher for a given subject.
        // BS+CS-only common → returns BS & CS only.
        // Arts-join subject  → returns Arts, BS & CS.
        function getSectionsForSubject(grade, subject) {
            if (!isCommonTeacherSubject(grade, subject)) return [];
            var includeArts = artsJoinsSubject(grade, subject);
            return CLASSES.filter(function (c) {
                if (c.grade !== grade) return false;
                if (c.section === 'BS' || c.section === 'CS') return true;
                if (c.section === 'ARTS' && includeArts) return true;
                return false;
            });
        }

        // Legacy helper kept for Settings modal (all three sections for a grade)
        function getAllSectionsForGrade(grade) {
            return CLASSES.filter(function (c) {
                return c.grade === grade && (c.section === 'BS' || c.section === 'CS' || c.section === 'ARTS');
            });
        }

        // ── View switching ────────────────────────────────────────────────────────
        function showView(view, el) {
            currentView = view;
            document.querySelectorAll('.view-item').forEach(function (item) { item.classList.remove('active'); });
            if (el) el.classList.add('active');

            var daySelect = document.getElementById('daySelect');
            if (daySelect) daySelect.style.display = (view === 'classes' || view === 'teachers') ? 'inline-block' : 'none';

            var titles = { classes: 'Classes Timetable - ' + currentDay, teachers: 'Teachers Timetable - ' + currentDay, individual: getIndividualClassTitle() };
            document.getElementById('pageTitle').textContent = titles[view];
            renderTimetable();
        }

        function showIndividualClass() {
            if (currentView !== 'individual') {
                document.querySelectorAll('.view-item').forEach(function (item) { item.classList.remove('active'); });
                var items = document.querySelectorAll('.view-item');
                if (items[2]) items[2].classList.add('active');
                currentView = 'individual';
                var daySelectEl = document.getElementById('daySelect');
                if (daySelectEl) daySelectEl.style.display = 'none';
            }
            document.getElementById('pageTitle').textContent = getIndividualClassTitle();
            renderTimetable();
        }

        function getIndividualClassTitle() {
            var sel = document.getElementById('classDropdown');
            var val = sel ? sel.value : '';
            if (!val) return 'Select Class';
            var cls = null;
            for (var i = 0; i < CLASSES.length; i++) { if (CLASSES[i].id === val) { cls = CLASSES[i]; break; } }
            return cls ? cls.name : val;
        }

        function selectDay(day) {
            currentDay = day;
            var daySelect = document.getElementById('daySelect');
            if (daySelect) daySelect.value = day;
            document.getElementById('pageTitle').textContent = (currentView === 'classes' ? 'Classes' : 'Teachers') + ' Timetable - ' + day;
            renderTimetable();
        }

        // ── Modal ─────────────────────────────────────────────────────────────────
        function openEditModal(classId, period) {
            if (currentView !== 'classes') {
                showAlert('Please switch to Classes Timetable view to edit', 'warning');
                return;
            }

            currentClass = classId;
            currentPeriod = period;
            editingCell = { classId: classId, period: period };

            var cls = null;
            for (var i = 0; i < CLASSES.length; i++) { if (CLASSES[i].id === classId) { cls = CLASSES[i]; break; } }

            document.getElementById('modalClass').value = classId + ' (' + cls.name + ')';
            document.getElementById('modalDay').value = currentDay;
            document.getElementById('modalPeriod').value = 'Period ' + period;

            // Subjects
            var available = getAvailableSubjects(classId);
            var subjectHtml = '<option value="">Select Subject</option>';
            available.forEach(function (s) {
                var isCommon = (cls.grade === 10 || cls.grade === 9) && isCommonTeacherSubject(cls.grade, s);
                subjectHtml += '<option value="' + s + '">' + s + (isCommon ? ' \uD83D\uDC65' : '') + '</option>';
            });
            document.getElementById('subjectSelect').innerHTML = subjectHtml;

            // Teachers
            var teacherHtml = '<option value="">Select Teacher</option>';
            getAvailableTeachers(period, classId, null).forEach(function (t) {
                teacherHtml += '<option value="' + t + '">' + t + '</option>';
            });
            document.getElementById('teacherSelect').innerHTML = teacherHtml;

            var existing = schedule[currentDay][classId][period];
            if (existing) {
                document.getElementById('subjectSelect').value = existing.subject;
                document.getElementById('teacherSelect').value = existing.teacher;
                onSubjectChange();
            } else {
                document.getElementById('commonTeacherInfo').style.display = 'none';
                document.getElementById('applyToAllSections').style.display = 'none';
            }

            document.getElementById('editModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
            currentClass = currentPeriod = editingCell = null;
        }

        function onSubjectChange() {
            var subject = document.getElementById('subjectSelect').value;
            var cls = null;
            for (var i = 0; i < CLASSES.length; i++) { if (CLASSES[i].id === currentClass) { cls = CLASSES[i]; break; } }
            if (!cls) return;

            var isCommon = (cls.grade === 10 || cls.grade === 9) && subject && isCommonTeacherSubject(cls.grade, subject);
            document.getElementById('commonTeacherInfo').style.display = isCommon ? 'block' : 'none';
            document.getElementById('applyToAllSections').style.display = isCommon ? 'flex' : 'none';

            if (isCommon) {
                var sections = getSectionsForSubject(cls.grade, subject);
                var sectionNames = sections.map(function (s) { return s.section; }).join(', ');
                document.getElementById('commonTeacherInfoText').textContent =
                    'This subject will be taught by the same teacher across: ' + sectionNames + ' sections.';
                var lbl = document.getElementById('applyAllLabel');
                if (lbl) lbl.textContent = 'Apply to ' + sectionNames + ' sections';
                var sm = document.getElementById('applyAllSmall');
                if (sm) sm.textContent = 'Same subject & teacher will be set for ' + sectionNames;
            }

            // Refresh teacher list considering common constraint
            var available = getAvailableTeachers(currentPeriod, currentClass, subject);
            var teacherHtml = '<option value="">Select Teacher</option>';
            available.forEach(function (t) { teacherHtml += '<option value="' + t + '">' + t + '</option>'; });
            document.getElementById('teacherSelect').innerHTML = teacherHtml;

            // Re-apply existing teacher selection if still available
            var existing = schedule[currentDay][currentClass][currentPeriod];
            if (existing && existing.subject === subject) {
                document.getElementById('teacherSelect').value = existing.teacher;
            }
        }

        function getAvailableSubjects(classId) {
            var all = SUBJECTS[classId] || [];
            var used = {};
            for (var p = 1; p <= 8; p++) {
                if (p !== currentPeriod && schedule[currentDay][classId][p]) {
                    used[schedule[currentDay][classId][p].subject] = true;
                }
            }
            return all.filter(function (s) { return !used[s]; });
        }

        function getAvailableTeachers(period, classId, subject) {
            var cls = null;
            for (var i = 0; i < CLASSES.length; i++) { if (CLASSES[i].id === classId) { cls = CLASSES[i]; break; } }

            // If common subject: check if another section already has this assigned — lock to that teacher
            if (subject && cls && (cls.grade === 10 || cls.grade === 9) && isCommonTeacherSubject(cls.grade, subject)) {
                var sections = getSectionsForSubject(cls.grade, subject);
                for (var j = 0; j < sections.length; j++) {
                    if (sections[j].id !== classId) {
                        var existing = schedule[currentDay][sections[j].id][period];
                        if (existing && existing.subject === subject) {
                            return [existing.teacher]; // Force same teacher
                        }
                    }
                }
            }

            // Normal: exclude teachers busy in this period (for other classes)
            var busy = {};
            CLASSES.forEach(function (c) {
                if (c.id !== classId && schedule[currentDay][c.id][period]) {
                    busy[schedule[currentDay][c.id][period].teacher] = true;
                }
            });
            return TEACHERS.filter(function (t) { return !busy[t]; });
        }

        // ── Save / Delete ─────────────────────────────────────────────────────────
        function saveAssignment() {
            var subject = document.getElementById('subjectSelect').value;
            var teacher = document.getElementById('teacherSelect').value;
            var applyAllSecs = document.getElementById('applyAllCheckbox').checked;
            var applyAllDays = document.getElementById('applyAllDaysCheckbox').checked;

            if (!subject || !teacher) { showAlert('Please select both subject and teacher', 'error'); return; }

            var cls = null;
            for (var i = 0; i < CLASSES.length; i++) { if (CLASSES[i].id === currentClass) { cls = CLASSES[i]; break; } }

            var isCommon = (cls.grade === 10 || cls.grade === 9) && isCommonTeacherSubject(cls.grade, subject);
            var daysToApply = applyAllDays ? DAYS : [currentDay];

            if (isCommon && applyAllSecs) {
                // Apply to the correct sections (BS+CS, or Arts+BS+CS) across chosen days
                var sections = getSectionsForSubject(cls.grade, subject);
                var sectionNames = sections.map(function (s) { return s.section; }).join(', ');
                daysToApply.forEach(function (day) {
                    sections.forEach(function (section) {
                        schedule[day][section.id][currentPeriod] = { subject: subject, teacher: teacher };
                    });
                });
                var dayLabel = applyAllDays ? 'all days' : currentDay;
                showAlert('Assigned ' + subject + ' with ' + teacher + ' to ' + cls.grade + 'th ' + sectionNames + ' (' + dayLabel + ')', 'success');
            } else {
                // Single class only
                if (isTeacherBusy(teacher, currentPeriod, currentClass)) {
                    showAlert('Teacher ' + teacher + ' is already assigned in Period ' + currentPeriod + ' on ' + currentDay, 'error');
                    return;
                }
                daysToApply.forEach(function (day) {
                    schedule[day][currentClass][currentPeriod] = { subject: subject, teacher: teacher };
                });
                var dayLabel2 = applyAllDays ? 'all days' : currentDay;
                showAlert('Assigned ' + subject + ' with ' + teacher + ' to ' + currentClass + ' (' + dayLabel2 + ')', 'success');
            }

            saveSchedule();
            renderTimetable();
            closeModal();
        }

        function deleteAssignment() {
            if (!editingCell) return;
            var cls = null;
            for (var i = 0; i < CLASSES.length; i++) { if (CLASSES[i].id === editingCell.classId) { cls = CLASSES[i]; break; } }
            var existing = schedule[currentDay][editingCell.classId][editingCell.period];
            if (!existing) { closeModal(); return; }

            var isCommon = (cls.grade === 10 || cls.grade === 9) && isCommonTeacherSubject(cls.grade, existing.subject);

            if (isCommon) {
                var sections = getSectionsForSubject(cls.grade, existing.subject);
                var sectionNames = sections.map(function (s) { return s.section; }).join(', ');
                var allDays = confirm('Delete "' + existing.subject + '" from ' + sectionNames + ' sections?\n\nOK = All days\nCancel = ' + currentDay + ' only');
                var daysToDelete = allDays ? DAYS : [currentDay];
                daysToDelete.forEach(function (day) {
                    sections.forEach(function (section) {
                        delete schedule[day][section.id][editingCell.period];
                    });
                });
                showAlert('Deleted ' + existing.subject + ' from ' + sectionNames + ' (' + (allDays ? 'all days' : currentDay) + ')', 'warning');
            } else {
                var allDays2 = confirm('Delete "' + existing.subject + '" from ' + editingCell.classId + '?\n\nOK = All days\nCancel = ' + currentDay + ' only');
                var daysToDelete2 = allDays2 ? DAYS : [currentDay];
                daysToDelete2.forEach(function (day) {
                    delete schedule[day][editingCell.classId][editingCell.period];
                });
                showAlert('Deleted ' + existing.subject + ' from ' + editingCell.classId + ' (' + (allDays2 ? 'all days' : currentDay) + ')', 'warning');
            }

            saveSchedule();
            renderTimetable();
            closeModal();
        }

        function isTeacherBusy(teacher, period, excludeClass) {
            for (var i = 0; i < CLASSES.length; i++) {
                var c = CLASSES[i];
                if (c.id !== excludeClass && schedule[currentDay][c.id][period] && schedule[currentDay][c.id][period].teacher === teacher) {
                    return true;
                }
            }
            return false;
        }

        // ── Settings ──────────────────────────────────────────────────────────────
        function showCommonTeacherSettings() {
            var container = document.getElementById('commonTeacherSettings');
            container.innerHTML = '';

            ['10', '9'].forEach(function (grade) {
                var gradeDiv = document.createElement('div');
                gradeDiv.className = 'section-group';
                gradeDiv.innerHTML = '<div class="section-group-header">' + grade + 'th Grade</div><div class="section-group-content" id="grade' + grade + 'Settings"></div>';
                container.appendChild(gradeDiv);

                var content = document.getElementById('grade' + grade + 'Settings');

                // 1. BS & CS only subjects — toggleable
                var bscsLabel = document.createElement('p');
                bscsLabel.style.cssText = 'font-weight:600;color:#2c3e50;margin-bottom:8px;font-size:0.9rem;';
                bscsLabel.textContent = 'BS & CS only (same teacher for BS and CS, Arts independent):';
                content.appendChild(bscsLabel);

                var bscsSubjects = grade === '10' ? COMMON_SUBJECTS_BS_CS_10 : COMMON_SUBJECTS_BS_CS_9;
                bscsSubjects.forEach(function (subject) {
                    var isChecked = commonTeacherConfig[grade].subjects[subject] ? 'checked' : '';
                    var isActive = commonTeacherConfig[grade].subjects[subject];
                    var settingDiv = document.createElement('div');
                    settingDiv.className = 'setting-item' + (isActive ? ' active' : '');
                    settingDiv.innerHTML =
                        '<h4>' + subject + '</h4>' +
                        '<p>Same teacher for BS and CS sections only</p>' +
                        '<label class="toggle-switch">' +
                        '<input type="checkbox" onchange="toggleCommonSubject(\'' + grade + '\',\'' + subject + '\',this.checked)" ' + isChecked + '>' +
                        '<span class="slider"></span></label>';
                    content.appendChild(settingDiv);
                });

                // 2. Arts + BS + CS subjects — always active, non-toggleable
                var artsLabel = document.createElement('p');
                artsLabel.style.cssText = 'font-weight:600;color:#2c3e50;margin:15px 0 8px;font-size:0.9rem;';
                artsLabel.textContent = 'Arts + BS + CS (always active — same teacher across all three sections):';
                content.appendChild(artsLabel);

                var artsSubjects = grade === '10' ? ARTS_JOINS_10 : ARTS_JOINS_9;
                artsSubjects.forEach(function (subject) {
                    var settingDiv = document.createElement('div');
                    settingDiv.className = 'setting-item active';
                    settingDiv.style.opacity = '0.85';
                    settingDiv.innerHTML =
                        '<h4>' + subject + ' <span style="font-size:0.75rem;background:#27ae60;color:white;padding:2px 7px;border-radius:3px;vertical-align:middle;">Always On</span></h4>' +
                        '<p>Same teacher for Arts, BS and CS sections</p>';
                    content.appendChild(settingDiv);
                });
            });

            document.getElementById('settingsModal').classList.add('active');
        }

        function toggleCommonSubject(grade, subject, enabled) {
            commonTeacherConfig[grade].subjects[subject] = enabled;
            // Update UI
            var items = document.querySelectorAll('.setting-item');
            for (var i = 0; i < items.length; i++) {
                var h4 = items[i].querySelector('h4');
                if (h4 && h4.textContent === subject) {
                    if (enabled) items[i].classList.add('active');
                    else items[i].classList.remove('active');
                }
            }
        }

        function saveCommonTeacherSettings() {
            saveCommonTeacherConfig();
            closeSettingsModal();
            renderTimetable();
            showAlert('Common teacher settings saved', 'success');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // ── Utilities ─────────────────────────────────────────────────────────────
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function showAlert(message, type) {
            var container = document.getElementById('alertContainer');
            var alert = document.createElement('div');
            alert.className = 'alert alert-' + type + ' show';
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(function () { if (alert.parentNode) alert.parentNode.removeChild(alert); }, 3000);
        }

        function printTimetable() { window.print(); }

        function clearDay() {
            if (confirm('Clear all assignments for ' + currentDay + '?')) {
                CLASSES.forEach(function (cls) { schedule[currentDay][cls.id] = {}; });
                saveSchedule();
                renderTimetable();
                showAlert(currentDay + ' cleared', 'warning');
            }
        }

        // Close modal on backdrop click (cross-browser)
        window.onclick = function (event) {
            var modals = document.querySelectorAll('.modal');
            for (var i = 0; i < modals.length; i++) {
                if (event.target === modals[i]) modals[i].classList.remove('active');
            }
        };

        // Init on load (cross-browser)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>

</html>